# 用户使用手册

### 免责声明
本人仅出于学习 python 网络爬虫目的编写此程序。用户在使用本程序时，必须遵守当地的法律法规。如果用户使用本程序进行任何非法行为，用户需自行承担相应后果，与本程序作者无关。本程序作者不对用户使用本程序造成的任何直接或间接损失负责。使用本程序即表示接受此免责声明。

## 0. 注意事项
在 `市集.exe` 程序所在的文件夹下，你需要检查是否有如下的文件，如果没有你可能需要自己加上
+ 文件 `cookie.txt`（必需）：你需要在这个文件里面放你的 cookie（详见下面 1.1）
+ 文件 `config.txt`（视情况必需）：如果你使用 MySQL 数据库，你需要其中的 `[mysql config]` 段；如果你想在重连失败时自动切换 Clash 代理，你需要其中的 `[clash config]` 段；如果以上两个功能你都不使用，你可以不需要 `config.txt` 这个文件

## 1. 抓取商品信息
### 1.0 无脑省流版（不使用 MySQL，不使用自动切换代理）
+ 步骤1：打开 `cookie.txt`，输入你的 cookie（详见下面 1.1）
+ 步骤2：双击 `市集.exe` 运行程序，首先你会被要求选择“商品类别”，输入你想要获取记录的商品类别（如下）；后面四个选项都直接回车
  + `all` 全部商品
  + `fig` 手办
  + `model` 模型
  + `peri` 周边（很多大礼包也会在“周边”中）
  + `3C` 3C 数码
  + `gacha` 盲盒
+ 步骤3：等待，程序会自动在 `市集.exe` 同文件夹下创建一个新文件夹 `db`，自动抓取网站上的数据，存入数据库文件 `db/Bmarket.db`
+ 步骤4：出现“自动重连失败”的提示后，输入 "c" 后回车；如果频繁出现“自动重连失败”，先重置网络（断开wifi重连，换一个wifi，使用全局代理，等），然后输入 "c" 后回车

### 1.1 配置 cookie
在 cookie.txt 文件中，放入你的cookie，结尾不要有多余的空格或换行。一般来说，B站市集的 cookie 获取一次能用几天到一两周，如果提示“Cookie 无效”，你需要再次获取一次。

#### 如何获取自己的cookie
用电脑的网页浏览器打开[B站市集](https://mall.bilibili.com/neul-next/index.html?page=magic-market_index)，我们要获取的就是这个网站的 cookie，你也可以上网自行查找如何获取一个网站的 cookie，网络上能查到的一些常见方法在这里有可能行不通，建议使用下面介绍的方法。

如果你使用的是 edge 浏览器或谷歌浏览器，你可以完全跟着下面的步骤做，如果你使用的是其他的浏览器，操作也应该类似。
1. 在网页中鼠标单击右键，单击“检查”（或者直接快捷键 F12），页面右侧会出现一个窗口
    |edge 浏览器|谷歌浏览器|
    |-|-|
    |![](img/edge_1.jpg)|![](img/chrome_1.jpg)|

2. 在右侧窗口上方的菜单栏中，找到“网络”（Network）选项
    |edge 浏览器|谷歌浏览器|
    |-|-|
    |![](img/edge_2.jpg)|![](img/chrome_2.jpg)|

3. 选中“网络”选项后，刷新网页，右侧会刷出很多记录，找到最上面第一条记录，单击打开
    |edge 浏览器|谷歌浏览器|
    |-|-|
    |![](img/edge_3.jpg)|![](img/chrome_3.jpg)|

4. 选中“标头”（Header），然后找到 "Cookie" 这一栏，复制里面的这一堆内容，粘贴到我们的 `cookie.txt` 中，注意复制的时候不要多复制或漏复制内容，粘贴完后记得保存
    |edge 浏览器|谷歌浏览器|
    |-|-|
    |![](img/edge_4.jpg)|![](img/chrome_4.jpg)|

### 1.2 配置 MySQL
如果你使用 MySQL，你需要完成以下配置
1. 你首先需要在你的 MySQL 中新建一个名为 "Bmarket" 的数据库
2. 你需要在 `"config.txt"` 文件中的 `[mysql config]` 段中，按照模板填写数据库配置

### 1.3 配置 Clash
如果你想在重连失败时使用 Clash 自动切换代理，你需要完成以下配置
#### Clash 规则添加
**建议**你在 Clash 中添加一条针对市集域名 `mall.bilibili.com` 的规则，并使用你不常用的 Selector（比如 Spotify, Telegram, PayPal），这样切换代理就可以仅针对市集这一个网站，不会影响程序运行期间你的其他上网行为

添加规则最简单的方法是：打开 Clash 界面 - 配置 - 右键你使用的订阅 - 编辑文件，找到 `rules:`，在下面第一行仿照着添加一行 `- 'DOMAIN,mall.bilibili.com,PayPal'`（这里 `PayPal` 请替换成你实际使用的 Selector），然后保存，重启 Clash

你有可能在你的 Clash 中找不到上面所述的界面，这样，你可以通过“配置 - 应用目录”打开应用目录，然后进入 `profiles` 目录，用记事本打开其中的 yaml 配置文件（如果你有多个订阅，你可能需要找一找哪个是你使用的），找到 `rules:`，在下面第一行仿照着添加一行 `- 'DOMAIN,mall.bilibili.com,PayPal'`（这里 `PayPal` 请替换成你实际使用的 Selector），然后保存，重启 Clash

使用上面介绍的添加规则的方法，**会在订阅更新后失效**，所以你可以取消自动更新订阅，或者在订阅更新后重新做上面的操作。你也可以在网上查阅其他更好的添加规则的方法，使其不会失效。

#### 不使用规则
实际上，你也可以不添加规则。在 Clash 现有规则下，市集作为国内网站会走直连，我们切换代理就没有任何作用。所以，**如果你不添加规则，你必须使用全局代理**，同时在 `config.txt` 文件的 `[clash config]` 段中的 `selector` 你必须对应地填写 `GLOBAL`
这意味着程序运行期间，自动切换代理会直接修改全局代理，而同时你的 Clash 必须使用全局代理，这可能会影响你的上网。

#### 配置文件
在 `config.txt` 文件的 `[clash config]` 段中，按照模板填写 Clash 配置，一般来说除了 `selector` 你需要填写你使用的 Selector（如果你不使用规则，而使用全局代理，填写 `GLOBAL`），其他的配置使用默认的即可（`host` 默认为 `localhost`，`port` 默认为 `9090`，`secret` 默认为空。除非你知道它们的含义，且你修改过它们，否则请使用默认值）

### 1.4 程序选项
双击 `市集.exe` 运行程序，会有5个选项需要设置（如果选择默认，直接回车）
1. 商品类别
    + `all`: 所有商品
    + `fig`（默认）: 手办
    + `model`: 模型
    + `peri`: 周边（其中包括了大量的大礼包）
    + `3C`: 3C 数码
    + `gacha`: 盲盒
2. 排序方式
    请选择默认的 **`时间降序`，强烈建议不要选其他的**，即直接回车即可
3. 处理新记录的方式（建议使用默认的 `merge`）
    + `pull`: 只抓取新的商品记录（抓取到已有记录中存在的商品为止），原有的已失效商品**不会被删除**
    + `merge`（默认）: 抓取全部商品记录，并合并到现有记录中，原有的已失效商品会被删除
4. 使用的数据库（默认 `sqlite`）
    目前只支持 sqlite 和 MySQL 两种数据库（默认 sqlite）
    + 如果你的电脑（或你的服务器）上安装了 MySQL，更推荐使用 MySQL（详见上面 1.2）
    + 不熟悉数据库（特别是不会写 sql 代码）的用户，推荐你使用更轻量级的 sqlite 数据库，可以用附带的专用软件 DB Browser for SQLite 查询数据库（详细介绍见后面）
    + 你也可以选择 `both` 同时把记录添加到两个数据库中
5. 重连失败时是否自动切换代理（默认不使用 `n`）
    目前只支持使用 Clash 自动切换代理（详见上面 1.3）

### 1.5 风控处理
开始抓取数据后，可能会遇到风控（这是因为短时间内请求过多，服务器拒绝了访问）
遇到风控后，程序首先会尝试自动重连。自动重连失败时，如果你启用了自动切换代理，则程序会切换代理后继续执行，无需你操作；如果你没有启用自动切换代理，或者切换代理失败，你需要输入一个对应的字母，决定下一步的操作：
+ c: 再次尝试连接，建议重连之前可以先手动重置网络连接（断开网络再连上 / 切换wifi / 等其他），再尝试重连
+ q: 撤销本次抓取
+ f: 如果已经抓取到的记录较多（大于5000），不推荐使用
+ m: 如果已经抓取到的记录较少（小于5000），不推荐使用

一般来说，只用c即可，手动重置网络后基本都能继续稳定运行较长一段时间。

----------------------------------------

## 2. 结果查询

### 2.0 无脑省流版
1. 双击打开 `数据库.exe`
2. 点击“打开数据库”，找到 `市集.exe` 所在的文件夹，进入子文件夹 `db`，选择 `Bmarket.db` 打开
<div align=center>
<img src="img/sqlite_1.jpg" style="zoom: 40%;" />
</div>

3. 点击“浏览数据”，查看数据表
<div align=center>
<img src="img/sqlite_2.jpg" style="zoom: 40%;" />
</div>

4. 可以在“表”处切换要查看的数据表（手办的数据在 `fig` 中，周边的数据在 `peri` 中）
<div align=center>
<img src="img/sqlite_3.jpg" style="zoom: 40%;" />
</div>

5. 可以在表的列名处单击，指定按照这个列排序；可以在列名下面的文本框中输入进行搜索
<div align=center>
<img src="img/sqlite_4.jpg" style="zoom: 40%;" />
</div>

6. 可以在文本框中右键单击，选择“设置过滤表达式”，实现更复杂的筛选条件
<div align=center>
<img src="img/sqlite_5.jpg" style="zoom: 40%;" />
</div>

7. 想要查看某个商品的详情，把其 "url" 列的内容复制到浏览器网址，即可查看

### 2.1 一些说明
在文件夹 `DB Browser for SQLite` 中附带了一个 sqlite 数据库浏览器，`数据库.exe` 实际上就是其中 `DB Browser for SQLite.exe` 的快捷方式，它实际上是一个独立的软件包，所以`DB Browser for SQLite` 这整个文件夹其实可以自由地直接迁移
